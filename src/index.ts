import { html } from "@elysiajs/html";
import { Elysia } from "elysia";
import {
  BASE_URL,
  PORT,
  generateFarcasterFrame,
  validateMessage,
} from "@/utils";
import staticPlugin from "@elysiajs/static";

const getResponse = async (req: Request): Promise<Response> => {
  let signedMessage;
  try {
    signedMessage = await req.json();
  } catch (error) {
    return new Response(
      JSON.stringify({ error: "Invalid JSON in request body" }),
      {
        status: 400,
        headers: { "Content-Type": "application/json" },
      }
    );
  }

  if (!signedMessage) {
    return new Response(JSON.stringify({ error: "Invalid request body" }), {
      status: 400,
      headers: { "Content-Type": "application/json" },
    });
  }

  const { untrustedData, trustedData } = signedMessage;

  // Validate the trustedData if it's present
  if (trustedData) {
    const isMessageValid = await validateMessage(trustedData.messageBytes);

    if (!isMessageValid) {
      return new Response(JSON.stringify({ error: "Invalid message" }), {
        status: 400,
        headers: { "Content-Type": "application/json" },
      });
    }
  }

  const choice = untrustedData.buttonIndex;

  let html = "";

  if (choice === 1) {
    html = generateFarcasterFrame(`${BASE_URL}/public/roll.png`, choice);
  } else {
    html = generateFarcasterFrame(`${BASE_URL}/public/roll.png`, choice);
  }

  return new Response(html, {
    status: 200,
    headers: { "Content-Type": "text/html" },
  });
};

const app = new Elysia()
  .use(staticPlugin())
  .use(html())
  .get(
    "/",
    () => `
    <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FarFrame</title>
    <meta property="og:title" content="Frame" />
    <meta property="og:image" content="${BASE_URL}/public/initial.png" />
    <meta property="fc:frame" content="vNext" />
    <meta property="fc:frame:image" content="${BASE_URL}/public/initial.png" />
    <meta property="fc:frame:button:1" content="\Ì¶Ì‚Í€Ì‰Í‹Í†Ì‰Ì‹Ì‡Ì¿Í‘ÍƒÍƒÌ”Ì‰Ì“Ì¿Ì†ÍŠÌƒÍ‰ÍˆÌ«Ì¨Ì²Ì¥Ì¯Ì¢Ì»ÍˆÌ¥Ì¢ÍœÌ±Ì±ÍŽÍŽÌ Í‡Ì¬Ì¼Í™ÍÌºÌ¬ÌªÍ–Ì¢Ì¨Í‰Ì–Ì¹
    ÌµÌÍ’Í„Í„Ì„ÍÍ ÌŒÌ‰ÍÍŒÍ†Í‹ÌÌŠÌ‡Í‘ÌˆÌ”Ì¿Í ÌšÍÌ‚ÌÍ‚ÌÌŒÌ„ÍÌÍ•Ì§Í™Ì_Ì¶Í’Ì½Í’ÌÍÍ„Ì„ÍÌƒÍ ÌÌ„ÌˆÌ…Ì‡ÍÌ¾ÌÌ‹ÌÌ†ÍÍÍÌ…Ì›ÌˆÌ‰ÌÌ•ÍšÌ§Ì£ÌžÌ™ÍŽÌ¥Ì™Ì¡Ì—Ì Ì¦ÌžÌ¼Ì®Ì²Ì©Í™ÌºÌ¡Í…Í–Ì–Ì§Í‡_Ì¶ÌÌ‘ÍŒÍ—Ì„Í‚Í—Í‚Ì—Ì¦Í‰Ì¤ÌªÌ±ÍœÌ™Ì¬|ÌµÌ‡Í†Í„Í’ÍÌ…Í‘Í‘Í‹Í Í”Ì¥Ì³ÍˆÌ±Ì²ÍœÍ™ÍœÌ™Ìª
    Ì¸Ì‰ÍŒÌÌ’ÌŠÍ˜Ì›Í˜ÍƒÍŠÌ‹ÍŠÌƒÌÌ€Ì„Ì•ÌŽÌÍ‚ÍŠÌŒÍ’ÍŠÍÍ Ì‹Ì”Ì‰Ì¾Ì“Ì³Í”Ì¦Ì§Í‡Í‰Ì»Ì®ÍÌª|Ì¸Ì…ÌÍŒÌŒÌŽÍƒÍ‹Ì’ÍƒÍ‹Ì…Ì›Ì’Ì¿ÌŒÌ›ÌˆÍ˜Ì‰Ì”Ì’Í„Ì„Í‡Ì¯Í•ÌŸÍ“Ì—Í‡Í–Í™Ì—ÍˆÌÌÌ¦ÍÌ¬Ì²Ì®Ì¢Ì¬Ì¡Ì™Ì±Ì Ì¦ÍÍ“Ì§ÌªÍœÌª]ÌµÌÌŽÍ’Ì…ÌÌ›ÍÌÍ‚ÍƒÌ†Í›Í—ÌÌ‚ÍÌ‚ÌºÌ–Ì˜Í‰Ì¼Í‡Í‰Í•ÌÍ”Ì¥Ì±Ì—Ì¥Ì²[Ì´ÍÌ¿Í ÍÌ†Í ÌŒÌÌ’ÌÍ„ÌÍ‹Ì¿Ì‘Í›ÌžÍ•Ì¯Í‰ÌÍ–Ì¬ÍŽÌŸÍˆÌžÍÌžÍœÍˆÌ­
    Ì¸Ì•ÌÌ“Í‘Í—Í’Ì‰Í›ÍƒÍ‘ÌŠÌ•Í†Ì‚ÌŽÍ†ÍƒÌ‰Í„Í ÌˆÌ‹ÍÌ†Í—Ì‘Ì…ÌƒÌ¢Í‰Ì˜Í™Í™ÌŸÍˆÌ¯Ì Ì¦Ì©Ì³ÍˆÌ™Íˆ]ÌµÌˆÍƒÍ‹Ì‰Ì„Í ÌŒÌ…ÍŠÌ„Ì¦Ì»Ì§Ì»Ì¬Ì©Ì»ÍˆÌ±ÌžÍ™Ì¡Ì³Í“ÌªÌŸÌ¬Í”Ì¹Í“Ì¨Ì«Í|Ì·ÌšÌ¿Í„ÌŒÌÍ‚Ì‡ÌÌ¿Í’ÌŠÍ†ÍŠÌ›Ì‹Í›Ì…Ì‘Í‘Ì‰ÍÌ‹Ì›ÌšÌ€Ì¿Í—Ì›Ì•ÌºÌ«Ì–Í•Ì¢Ì³Í‰Ì©Ì Ì˜Ì–Í–Ì°ÍŽ
    Ì¸Í˜ÌŒÌ‘ÌÍ†ÌÌ‹Í‹Ì“Ì“Ì‚Ì¢Ì¡Ì¯Ì¯Í…Ì§ÌºÌ«Ì­Í‰Ì§ÍÍ‰ Ì´Í—ÍÍ—Ì…ÌÍŒÍ‚Í›Í€Í„ÌƒÍ†Í’ÌÌÌªÍ‡ÌªÌ»Í‡Í”Í“Ì²Ì¦Í…Ì£Ì§Í“ÌÍœÌ™ÌºÌªÍ\Ì¸Ì‡Ì‚Ì‡ÍÌÌ…ÍÌ¿Í’Ì’Ì•ÌŠÍ˜ÌŽÌŒÍ„ÌÌ½ÍÌ”ÍÌ›ÌÍ ÌÍ˜ÍœÌŸÌ˜Ì¥Í–ÌºÌ¬ÍŽÌ¬Í‡Í‡Í‰|ÌµÍ†Ì‘Ì”Í†ÌˆÌŠÌ†Í˜Í‚Í–Ì©ÌŸÌ®Ì¨Í‰Ì°Í“Ì³Ì Ì¹Ì®Ì®Ì–Ì²Í‰ÌžÌ­Ì­
    ÌµÌˆÍŒÌ’ÌŠÍƒÍ‘Ì”Í‘Ì¹Ì®Ì¥Í“ÍŽÌ¼ÌžÌ¼ÍˆÌ¨Í”ÌÌ³Ì¥Ì³Ì¼Ì«Ì¹Ì®ÍÌ±ÌºÌ³ÌŸ\Ì¸Í˜ÌƒÌÌ‰Ì¾Í—Ì³Ì¨Ì–ÌžÌ¥Ì¡ÍšÌ®Ì³Ì¬Ì³Ì¨Ì™Ì–Í‡Ì–Í•Í‰ÌÍ”ÌŸÍ–Ì–Ì¹ Ì¸ÌÌˆÌ½Í†Í‹Í„ÌÌ‰Ì‡Ì‡ÌÌ‘ÌÍ˜Í€Ì†ÌÍ ÌÌ’Ì¿Ì‡Ì…ÍÍ Í†Ì‹Ì½ÌˆÌ‡Ì¤Ì–ÍˆÌœÍ™Í”Í™Í‰Í“
    Ì¶Í›Í‚Ì•Ì…Ì„ÌÍŒÌƒÍÌ“Ì”Ì¾Í˜ÌŠÌ€ÍÌšÍ—Í€Ì‰Ì…Ì‹Í„Í—Ì¢ÍšÍŽÌ ÍšÌ¯Ì¯ÌœÌ¹Ì©Ì®ÌœÌ­Ì˜Ì­ÌÌ²Ì°ÌªÍ•Ì­\Ì´ÌÍÍÌ‚Í‹Í‘ÌÍ„Ì‰ÌšÍ‚Í€Í€ÌšÌÌŠÍ„Ì“Ì‚Í˜Í›Ì“Í‚Í€Ì“ÍÍ’Ì®Ì¦ÌªÌ£ÌŸ
    Ì¶Í›ÌÌ‹Í‘ÌŽÌ‰Ì”Ì¾Ì›Í‚ÌŽÌ•ÌÍ„ÌŒÌ›Í„Í‘Í’ÍŒÍ‚Ì§Ì«Ì–Ì—Ì¥Ì§Ì³ÌŸÌœÍœÌ˜Ì«Ì¯ÌªÌ¹Ì­Ì­Ì™Ì©ÌœÌªÌŸÌ™ÌŸÍˆÌ«Ì®Ì¢Ì¬Ì¥\Ì¶Ì•ÌŽÍ—Í‡Ì§Ì˜Í‡Í“Ì Ì–Ì–ÍŽÌ¬Ì—Ì£Í‡ÍÌ¨Ì¡Ì¢Ì¥Í…ÍÌ¨Ì Ì¤Ì—Ì¤Ì®_Ì¶Ì‘Ì„Ì…ÌÌŒÌŽÍÌ†ÍÌ¿Í—ÍƒÍ—Í‡ÍŽÍŽÍÌ§ÌžÌ°ÍÌœÌ¥Í‰Ì—Ì¥ÍšÌ—Ì±Í‰ÌœÍ“Ì©ÍœÍ™Ì³Ì¡Ì¢Ì³ Ì¶Ì‰Í†Ì Ì–Í™Ì£Ì°Ì–Í•Í“Ì¹ÌªÍ•Ì©Ì£ÍˆÌ¥Ì—ÍŽÌ°ÌžÍ…\Ì¶Í Ì®\Ì·Ì„Í˜Ì€ÌÍŠÌÌ†ÌšÍ˜ÌÌŽÌŠÌ›Í‘ÌŒÌ‘Ì€Í›Í ÍÌÍŠÌŽÍ’Í‹Í„ÌˆÌ”Í‚Ì—ÍÍÍÌ¯Ì ÌºÌœÌ¬Í”Ì³Ì§Ì¬Ì—Ì™Ì£Í“ÍšÍ™Ì¢Í‰Ì­Ì¯
    Ì·ÌšÍŠÍÌŒÌÌŠÌ„ÌŠÌŠÌšÍ˜Ì†Í›ÌŒÌ„Ì„ÌÌ‘Ì¨Í…Ì¥Ì¤Ì™ÍÌ«Ì°Í•Ì°Ì¼ÍˆÌ«ÍÌºÍ™ÍŽÌªÌ¨Í“Ì³Ì™ÌŸÌœÌ˜Ì¤ÍˆÌ§Ì«Ì®Ì«Ì³]Ì´ÍÌ‰ÌÌšÍ—Ì¾ÍŒÌ›Í‹Ì¿Ì’ÍŒÌÌ…Í€Ì…Ì…Í‚Ì½ÌŽÌ’ÍÍ˜Í„ÌŠÌ­ÍšÍ–Ì­ÍÌ°Ì˜ÍœÍŽÌ©ÍœÌ±
    ÌµÍ‹Í—ÍÍ‹Í‚ÍÌ½Ì•Í†Ì„Ì“ÍƒÍ„ÌÌƒÍ’Ì‰Ì¤Ì¤Ì™Ì£Í‡Ì£Ì¬Ì°ÌÌ§ÌºÍ…ÍˆÌ§Í‡Ì«Ì˜Ì»Ì™ÌœÍ•Ì°Ì¨Í… Ì¶Ì’ÌŒÌ›Í Ì‘Í›Í†Í‘Í‹Ì‚ÌŠÌ†Ì‡Í„Í Í‘Ì’Ì‹ÍŒÌ‚ÌƒÌŒÌ€Ì„Í„Ì¾Ì¯ÍÌœÌºÌ¦Ì¢Í”Ì£Ì³Ì¬Ì®Ì°Ì®Ì­Ì°\Ì¸ÌŒÌ‘Í‘ÌÍÍŒÌˆÌ…ÌˆÌŒÌ’Í‘Ì‚ÌÍƒÌ‘Í›ÍÍ‹Í Í‚Ì¨ÍˆÍ“ÍšÌ®Ì«Ì¥Í‰Ì§Ì£Ì¬ÍˆÌ­Ì¡Ì°Ì¼Í“ÍÌ¦Ì­Ì¹Ì¨Ì²Í•
    ÌµÍ‘Ì‰Ì„Ì†Í›ÌÍ‚ÌˆÍÌ“ÍŒÌ‡ÍŒÍ‘ÍÍ—ÍÍŒÍ‹Í„Í‹ÌšÌŽÌ“ÍƒÌ€Ì½Ì‰Ì„ÌÌžÌ±Ì—\Ì·ÌƒÌ‡Í„ÍˆÍ“Ì§Ì¬Í”ÌªÌ¯Ì®ÍŽÌ²ÌŸÌžÌ¥ÍˆÌ¢Í•Í”Ì¨ÌŸÍ™Ì Ì®ÌºÌ¬Í•Í™Ì¥Í”ÍŽ ÌµÌ¿Í„Ì…ÌŠÍŒÌƒÌ‘ÍÍ—ÌšÌÌŠÍÌ¾ÌˆÍÌ‘Í€Ì§_Ì·ÌŽÍ˜ÌƒÌÍÌƒÍ˜Í ÌÌŠÍ˜ÍÌÌÍ’Ì¾Ì„ÍÌŽÌÍŠÌ•Ì†ÍƒÌÌšÍ†Ì‚Í—Í›ÍÍ‰Ì©Ì¯ÍšÌžÌŸÍšÌ©Ì®[Ì·Í„Ì„Ì‹Í˜Ì”Ì…Ì…Í‰Ì§Ì¬Ì¨Í‡Í‡Ì Í”]Ì´Ì¿ÍÌŒÌ’Í Ì•ÍÌ“ÍÍ„ÍŠÍ‚ÍÌ•Í…Í…ÍˆÌ¯Ì»ÌœÍšÌ­Ì¯Ì®Ì®Ì¨Ì®ÌºÌœÌ»Ì±Ì°Í“Ì¤Ì±ÌœÍš
    ÌµÍ„Ì‚ÌŒÌ½Ì¾Í†ÍŠÍÌ–Ì¥ÌºÍ•Ì¹Ì«Ì¯ÍšÌ§Ì«Ì¯ÍšÌ¨Ì¨|Ì´Ì‡Í‹Í›Ì”Ì‰Ì†ÌÌ‰ÌƒÌ‹ÌœÍ“ÍŽÍˆÌœÍŽÍ‰Í…Ì²Ì Ì¦Í” ÌµÌÌ‚ÍƒÍ Ì¿Ì‘ÌšÍ‚Ì”Ì…ÌŽÍ‘ÌÍÍ€ÌŠÌ‡Í—Í’Í†Ì†Ì’ÌƒÌ”Í„ÌºÍˆÌ¼Ì«\Ì·Ì‡Ì’ÌšÍÌ…Í„Í‘Ì›ÍÍ‹Í‹Í‘ÌˆÌŽÌÌ‚Ì¿Í‘Í‚ÌŠÌ½ÍŠÍƒÍ„Ì‚ÌžÌ¡Ì°Ì—Í”Ì¯Ì£Ì­Í™Ì»Ì¬ÍŽÌ²\Ì¸ÍƒÍ Ì‹ÍŒÌŽÌ•Ì€ÌˆÍÌˆÍƒÌ‘Í‘Í‚Í›ÌŠÌ”ÍŒÌŽÌ”Ì¾Ì†ÌŠÌ¾Ì¾Ì‘Ì›Í Ì“ÌˆÍŒÌ¢Í–Í”Ì–
    Ì¶ÌŒÍ‹Ì…ÌÌƒÍÌ‘Í’Ì¥Ì—Ì Í…ÌœÌÌºÌªÌ—ÍˆÍŽÍ…Í™Ì¯Í“ÍšÌ™ÌºÌ˜Ì¼Ì¥Ì¤Í”ÍˆÌ¢Í“ÍÍˆÌ¯Í”Ì§Ì§\ÌµÌÌ½ÍÌ‹ÍÌÌ“Í›Í„ÍÌŒÌ€Í„Í’ÌÌ€Í‚Í—Í Ì†Ì’Í›Ì€Ì‚Í—ÌªÌ±Ì±Í‡Ì¯Ì¬ÍÌÌžÌ–Ì¯Ì¼Ì–Ì­Í–Ì³Ì—Ì£Ì«Í–Ì™Ì¯Í…Ì£ÌªÍŽ" />

    <meta property="fc:frame:post_url" content="${BASE_URL}/api/frame" />
  </head>
<body>
  <h1>FarFrame</h1>
</body>
</html>

  `
  )
  .post("/api/frame", ({ request }) => getResponse(request))
  .listen(PORT!);

console.log(
  `ðŸ¦Š Elysia is running at ${app.server?.hostname}:${app.server?.port}`
);
